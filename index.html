<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–∞—Ä—Ç–∞ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .search-toggle {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1001;
      background: white;
      padding: 10px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }

    .search-box {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      width: 240px;
    }

    .search-box input {
      padding: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    .suggestions {
      margin-top: 6px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }

    .suggestion-item {
      padding: 4px;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background: #efefef;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- –õ—É–ø–∞ -->
<div class="search-toggle" onclick="toggleSearch()">üîç</div>

<!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
<div class="search-box" id="searchBox">
  <input type="text" id="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å" oninput="searchSuggestions()" />
  <div class="suggestions" id="suggestions"></div>
</div>

<script>
  // Telegram WebApp API
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  const bounds = L.latLngBounds(
    [56.2800, 30.5000],
    [56.4000, 30.6000]
  );

  const map = L.map('map', {
    center: [56.34, 30.54],
    zoom: 15,
    minZoom: 13,
    maxZoom: 18,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0
  });

  const mapTilerKey = 'm4YwiuXxbPBzQaJ1PRc0';

  // –°–ø—É—Ç–Ω–∏–∫–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
// –ó–ê–ú–ï–ù–ò
// L.tileLayer('...satellite...')

// –ù–ê:
  L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${mapTilerKey}&lang=ru`, {
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
  }).addTo(map);


  // –ü–æ–¥–ø–∏—Å–∏ (labels), –Ω–∞–ª–æ–∂–∏–º —Å–≤–µ—Ä—Ö—É
  L.tileLayer(`https://api.maptiler.com/maps/streets/256/{z}/{x}/{y}.png?key=${mapTilerKey}`, {
    opacity: 0.6,
    tileSize: 256,
    maxZoom: 18
  }).addTo(map);

  map.on('moveend', () => {
    if (!bounds.contains(map.getCenter())) {
      map.panInsideBounds(bounds, { animate: true });
    }
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
  function toggleSearch() {
    const box = document.getElementById('searchBox');
    box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
  }

  // –ü–æ–∏—Å–∫ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
  function searchSuggestions() {
    const query = document.getElementById('search').value;
    const container = document.getElementById('suggestions');
    if (!query) {
      container.innerHTML = '';
      return;
    }

    fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lang=ru&limit=10`)
      .then(res => res.json())
      .then(data => {
        container.innerHTML = '';
        data.features.forEach(place => {
          const label = place.properties.name || place.properties.street || place.properties.city || '–ú–µ—Å—Ç–æ';
          const fullLabel = place.properties.label || label;
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = fullLabel;
          item.onclick = () => {
            const [lon, lat] = place.geometry.coordinates;
            L.marker([lat, lon]).addTo(map)
              .bindPopup(fullLabel).openPopup();
            map.setView([lat, lon], 17);
            container.innerHTML = '';
          };
          container.appendChild(item);
        });
      });
  }
</script>

</body>
</html>
