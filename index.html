<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–∞—Ä—Ç–∞ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .search-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      gap: 6px;
    }

    .search-box input {
      padding: 6px;
      font-size: 14px;
      width: 200px;
    }

    .search-box button {
      padding: 6px 10px;
      font-size: 14px;
      background: #3390ec;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .search-box button:hover {
      background: #2678c8;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="search-box">
  <input type="text" id="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å" />
  <button onclick="searchAddress()">üîç</button>
</div>

<script>
  // Telegram WebApp API
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  // –ì—Ä–∞–Ω–∏—Ü—ã –í–µ–ª–∏–∫–∏—Ö –õ—É–∫ (—Å—É–∂–µ–Ω–Ω—ã–µ –ø–æ —à–∏—Ä–∏–Ω–µ, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏)
  const bounds = L.latLngBounds(
    [56.2800, 30.5000], // —é–≥–æ-–∑–∞–ø–∞–¥
    [56.4000, 30.6000]  // —Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫
  );

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  const map = L.map('map', {
    center: [56.34, 30.54],
    zoom: 14,
    minZoom: 13,
    maxZoom: 18,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0
  });

  // MapTiler —Å—Ç–∏–ª—å —Å API-–∫–ª—é—á–æ–º
  const mapTilerKey = 'm4YwiuXxbPBzQaJ1PRc0';
  L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${mapTilerKey}`, {
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18,
    attribution: '&copy; MapTiler & OpenStreetMap contributors'
  }).addTo(map);

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
  map.on('moveend', () => {
    if (!bounds.contains(map.getCenter())) {
      map.panInsideBounds(bounds, { animate: true });
    }
  });

  // –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ Photon API
  function searchAddress() {
    const query = document.getElementById('search').value;
    if (!query) return;

    fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lang=ru`)
      .then(res => res.json())
      .then(data => {
        if (data.features.length > 0) {
          const place = data.features[0];
          const [lon, lat] = place.geometry.coordinates;
          const label = place.properties.name || place.properties.label;

          L.marker([lat, lon])
            .addTo(map)
            .bindPopup(label || "–ù–∞–π–¥–µ–Ω–æ –º–µ—Å—Ç–æ")
            .openPopup();

          map.setView([lat, lon], 17);
        } else {
          alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }
      })
      .catch(() => alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ'));
  }

  // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  map.fitBounds(bounds);
</script>

</body>
</html>
