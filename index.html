<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            z-index: 1000;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .location-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .location-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .location-btn:hover {
            transform: scale(1.1);
        }

        .user-location-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(66, 133, 244, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0);
            }
        }

        .leaflet-popup-content {
            margin: 8px 12px;
            line-height: 1.4;
            font-size: 13px;
            min-width: 120px;
        }

        .status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ö–∞—Ä—Ç–∞ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫</h1>
            <div class="location-info" id="locationInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="status" id="status"></div>
            <button class="location-btn" onclick="findMyLocation()" title="–ù–∞–π—Ç–∏ –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">üìç</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –ì—Ä–∞–Ω–∏—Ü—ã –í–µ–ª–∏–∫–æ–ª—É–∫—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞------------------------------------------------------------------------------------------------------

        const bounds = L.latLngBounds(
            [56.2800, 30.4800],  // —é–≥–æ-–∑–∞–ø–∞–¥ (–±—ã–ª–æ 56.3000)
            [56.4000, 30.6200]   // —Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫ (–±—ã–ª–æ 56.3850)
        );



        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫–∞—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
        const map = L.map('map', {
            center: [56.3402, 30.5455],
            zoom: 14,
            minZoom: 13,        // –º–µ–Ω—å—à–µ –Ω–µ–ª—å–∑—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å
            maxZoom: 16,        // –º–∞–∫—Å–∏–º—É–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        });


        // –°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (Esri World Imagery)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri &mdash; —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
            maxZoom: 18
        }).addTo(map);
        
        // –ü–æ–¥–ø–∏—Å–∏ (–Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤, —É–ª–∏—Ü)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            attribution: '',
            maxZoom: 18,
            opacity: 0.9
        }).addTo(map);



 


        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        let userLocationMarker = null;
        let watchId = null;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
        function updateLocationInfo(text) {
            document.getElementById('locationInfo').textContent = text;
        }

        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(text, duration = 3000) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, duration);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function createUserLocationMarker(lat, lng, accuracy = null) {
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            
            const icon = L.divIcon({
                className: 'user-location-marker',
                html: `<div style="
                    background: #4285f4; 
                    width: 16px; 
                    height: 16px; 
                    border-radius: 50%; 
                    border: 3px solid white; 
                    box-shadow: 0 2px 8px rgba(66,133,244,0.6);
                "></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            userLocationMarker = L.marker([lat, lng], { icon }).addTo(map);
            
            let popupText = '<b>–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</b>';
            if (accuracy) {
                popupText += `<br>–¢–æ—á–Ω–æ—Å—Ç—å: ~${Math.round(accuracy)}–º`;
            }
            
            userLocationMarker.bindPopup(popupText);
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function onLocationFound(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ:', lat, lng);
            
            createUserLocationMarker(lat, lng, accuracy);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–∞–π–æ–Ω–µ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫
            const distance = getDistance(56.3402, 30.5455, lat, lng);
            
            if (distance < 50) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–∞–π–æ–Ω–µ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫
                map.setView([lat, lng], 16);
                updateLocationInfo(`–í—ã –≤ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫–∞—Ö (¬±${Math.round(accuracy)}–º)`);
                showStatus('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ!');
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª–µ–∫–æ –æ—Ç –≥–æ—Ä–æ–¥–∞
                updateLocationInfo(`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫: ${distance.toFixed(1)} –∫–º`);
                showStatus('–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –¥–∞–ª–µ–∫–æ –æ—Ç –í–µ–ª–∏–∫–∏—Ö –õ—É–∫');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function onLocationError(error) {
            console.log('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            let errorText = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorText = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorText = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    break;
                case error.TIMEOUT:
                    errorText = '–¢–∞–π–º-–∞—É—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è';
                    break;
            }
            
            updateLocationInfo(errorText);
            showStatus(errorText);
        }

        // –ü–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function findMyLocation() {
            if (!navigator.geolocation) {
                showStatus('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }

            showStatus('–ü–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');
            
            navigator.geolocation.getCurrentPosition(
                onLocationFound,
                onLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000
                }
            );
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initLocation() {
            updateLocationInfo('–ü–æ–∏—Å–∫ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');
            
            if (navigator.geolocation) {
                findMyLocation();
                
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                watchId = navigator.geolocation.watchPosition(
                    onLocationFound,
                    onLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                updateLocationInfo('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        }

        // –°–æ–±—ã—Ç–∏—è –∫–∞—Ä—Ç—ã
        map.on('load', function() {
            showStatus('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });

        map.on('click', function(e) {
            console.log('–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ:', e.latlng);
        });
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–∞—Ä—Ç—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑—É–º–∞ ----------------------------------------------------------------------------------------------
        map.setMinZoom(13);
        map.setMaxZoom(18);
        
        map.on('moveend', function () {
            if (!bounds.contains(map.getCenter())) {
                map.panInsideBounds(bounds, { animate: true });
            }
        });


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞
            map.fitBounds(bounds);
            setTimeout(initLocation, 1000);
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>
