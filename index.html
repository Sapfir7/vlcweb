<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта города</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            z-index: 1000;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
        }

        .category-btn {
            padding: 6px 12px;
            border: 1px solid var(--tg-theme-button-color, #3390ec);
            background: transparent;
            border-radius: 16px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--tg-theme-button-color, #3390ec);
        }

        .category-btn.active {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .add-marker-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .add-marker-btn:hover {
            transform: scale(1.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 24px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            font-size: 14px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn:hover {
            opacity: 0.8;
        }

        .marker-popup {
            min-width: 200px;
        }

        .marker-popup h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .marker-popup .category-tag {
            display: inline-block;
            padding: 2px 8px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 12px;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .marker-popup p {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .marker-popup .author {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Карта Великих Лук</h1>
            <div class="categories">
                <button class="category-btn active" data-category="all">Все</button>
                <button class="category-btn" data-category="events">События</button>
                <button class="category-btn" data-category="places">Места</button>
                <button class="category-btn" data-category="issues">Проблемы</button>
                <button class="category-btn" data-category="finds">Находки</button>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <button class="add-marker-btn" onclick="openAddMarkerModal()">+</button>
        </div>
    </div>

    <div class="modal" id="addMarkerModal">
        <div class="modal-content">
            <h3>Добавить метку</h3>
            <form id="markerForm">
                <div class="form-group">
                    <label for="markerTitle">Название</label>
                    <input type="text" id="markerTitle" required>
                </div>
                <div class="form-group">
                    <label for="markerCategory">Категория</label>
                    <select id="markerCategory" required>
                        <option value="events">События</option>
                        <option value="places">Места</option>
                        <option value="issues">Проблемы</option>
                        <option value="finds">Находки</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="markerDescription">Описание</label>
                    <textarea id="markerDescription" placeholder="Расскажите подробнее..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeAddMarkerModal()">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Настройки карты
        const map = L.map('map').setView([56.3402, 30.5455], 13); // Великие Луки

        // Добавление тайлов карты
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Хранение меток
        let markers = [];
        let currentCategory = 'all';
        let tempMarkerPosition = null;

        // Цвета для категорий
        const categoryColors = {
            events: '#ff6b6b',
            places: '#4ecdc4',
            issues: '#ffa726',
            finds: '#ab47bc'
        };

        // Загрузка меток из localStorage
        function loadMarkers() {
            const savedMarkers = localStorage.getItem('cityMapMarkers');
            if (savedMarkers) {
                markers = JSON.parse(savedMarkers);
                displayMarkers();
            }
        }

        // Сохранение меток в localStorage
        function saveMarkers() {
            localStorage.setItem('cityMapMarkers', JSON.stringify(markers));
        }

        // Отображение меток на карте
        function displayMarkers() {
            // Очистка существующих меток
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Добавление меток
            markers.forEach(markerData => {
                if (currentCategory === 'all' || markerData.category === currentCategory) {
                    const marker = L.marker([markerData.lat, markerData.lng], {
                        icon: createCustomIcon(markerData.category)
                    }).addTo(map);

                    const popupContent = `
                        <div class="marker-popup">
                            <h4>${markerData.title}</h4>
                            <div class="category-tag">${getCategoryName(markerData.category)}</div>
                            <p>${markerData.description}</p>
                            <div class="author">Добавлено: ${markerData.author}</div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }

        // Создание кастомной иконки
        function createCustomIcon(category) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${categoryColors[category]}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        // Получение названия категории
        function getCategoryName(category) {
            const names = {
                events: 'События',
                places: 'Места',
                issues: 'Проблемы',
                finds: 'Находки'
            };
            return names[category] || category;
        }

        // Обработка клика по карте
        map.on('click', function(e) {
            tempMarkerPosition = e.latlng;
        });

        // Открытие модального окна
        function openAddMarkerModal() {
            if (!tempMarkerPosition) {
                alert('Сначала нажмите на карту, чтобы выбрать место для метки');
                return;
            }
            document.getElementById('addMarkerModal').style.display = 'flex';
        }

        // Закрытие модального окна
        function closeAddMarkerModal() {
            document.getElementById('addMarkerModal').style.display = 'none';
            document.getElementById('markerForm').reset();
            tempMarkerPosition = null;
        }

        // Обработка формы добавления метки
        document.getElementById('markerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('markerTitle').value;
            const category = document.getElementById('markerCategory').value;
            const description = document.getElementById('markerDescription').value;
            
            const newMarker = {
                id: Date.now(),
                lat: tempMarkerPosition.lat,
                lng: tempMarkerPosition.lng,
                title: title,
                category: category,
                description: description,
                author: tg?.initDataUnsafe?.user?.first_name || 'Анонимный пользователь',
                timestamp: new Date().toISOString()
            };

            markers.push(newMarker);
            saveMarkers();
            displayMarkers();
            closeAddMarkerModal();

            // Уведомление Telegram
            if (tg) {
                tg.showAlert('Метка успешно добавлена!');
            }
        });

        // Переключение категорий
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Обновление активной кнопки
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Обновление текущей категории
                currentCategory = this.dataset.category;
                displayMarkers();
            });
        });

        // Закрытие модального окна по клику вне его
        document.getElementById('addMarkerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddMarkerModal();
            }
        });

        // Инициализация
        loadMarkers();

        // Попытка определить местоположение пользователя (для точности в районе Великих Лук)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                // Проверяем, что пользователь в районе Великих Лук (примерно в радиусе 50 км)
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const distance = getDistance(56.3402, 30.5455, userLat, userLng);
                
                if (distance < 50) { // в радиусе 50 км от центра города
                    map.setView([userLat, userLng], 15);
                }
            });
        }

        // Функция для расчета расстояния между точками
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // радиус Земли в км
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>
