<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
    
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .search-container {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 70px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.2);
      max-width: 400px;
      transition: all 0.3s ease;
    }

    .search-input-container {
      position: relative;
      padding: 4px;
    }

    .search-input {
      width: 100%;
      font-size: 16px;
      padding: 14px 50px 14px 20px;
      border: none;
      border-radius: 12px;
      outline: none;
      background: transparent;
      color: #2d3748;
      font-weight: 400;
    }

    .search-input::placeholder {
      color: #a0aec0;
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #718096;
      font-size: 18px;
      pointer-events: none;
    }

    .clear-search {
      position: absolute;
      right: 45px;
      top: 50%;
      transform: translateY(-50%);
      background: #e2e8f0;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      color: #4a5568;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .clear-search:hover {
      background: #cbd5e0;
    }

    .suggestions {
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid rgba(226, 232, 240, 0.6);
      margin-top: 4px;
    }

    .suggestion-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(226, 232, 240, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .suggestion-item:hover {
      background: rgba(99, 102, 241, 0.1);
    }

    .suggestion-item:last-child {
      border-bottom: none;
      border-radius: 0 0 12px 12px;
    }

    .suggestion-icon {
      font-size: 16px;
      opacity: 0.7;
    }

    .suggestion-text {
      flex: 1;
      font-size: 14px;
      color: #2d3748;
      line-height: 1.4;
    }

    .suggestion-type {
      font-size: 12px;
      color: #718096;
      background: #f7fafc;
      padding: 2px 8px;
      border-radius: 6px;
    }

    .leaflet-control-zoom {
      border-radius: 12px !important;
      border: none !important;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .leaflet-control-zoom a {
      border-radius: 0 !important;
      border: none !important;
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      color: #4a5568 !important;
      font-weight: 600 !important;
      transition: all 0.2s ease !important;
    }

    .leaflet-control-zoom a:hover {
      background: rgba(99, 102, 241, 0.1) !important;
      color: #6366f1 !important;
    }

    .leaflet-control-zoom a:first-child {
      border-radius: 12px 12px 0 0 !important;
    }

    .leaflet-control-zoom a:last-child {
      border-radius: 0 0 12px 12px !important;
    }

    .custom-marker {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      border: 3px solid white;
      position: relative;
      min-width: 100px;
      text-align: center;
      line-height: 1.2;
    }

    .custom-marker::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 12px 8px 0 8px;
      border-color: white transparent transparent transparent;
    }

    .symbol-marker {
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
      border: 4px solid white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #718096;
      font-size: 14px;
    }

    .no-results {
      text-align: center;
      padding: 20px;
      color: #718096;
      font-size: 14px;
    }

    /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    .add-buttons-panel {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }

    .add-button {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: none;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .add-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      background: rgba(99, 102, 241, 0.1);
    }

    .add-button.active {
      background: #6366f1;
      color: white;
      transform: scale(1.1);
    }

    .add-button-tooltip {
      position: absolute;
      right: 56px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .add-button:hover .add-button-tooltip {
      opacity: 1;
    }

    .scalable-marker {
      transition: transform 0.2s ease;
      transform-origin: bottom center;
    }


    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 16px;
    }

    .modal-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .modal-input:focus {
      border-color: #6366f1;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-button.cancel {
      background: #f7fafc;
      color: #4a5568;
    }

    .modal-button.cancel:hover {
      background: #e2e8f0;
    }

    .modal-button.confirm {
      background: #6366f1;
      color: white;
    }

    .modal-button.confirm:hover {
      background: #5856eb;
    }

    .cursor-crosshair {
      cursor: crosshair !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–¥ –º–µ—Ç–∫–æ–π */
    .leaflet-popup-content-wrapper {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border: none;
      padding: 0;
    }

    .leaflet-popup-content {
      margin: 0;
      padding: 16px 20px;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      line-height: 1.4;
    }

    .leaflet-popup-tip {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      box-shadow: none;
    }

    .leaflet-popup-close-button {
      color: white;
      font-size: 20px;
      font-weight: bold;
      padding: 8px 12px;
      opacity: 0.8;
    }

    .leaflet-popup-close-button:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      .search-container {
        left: 12px;
        right: 70px;
        top: 12px;
      }
      
      .search-input {
        font-size: 16px;
        padding: 12px 45px 12px 16px;
      }
      
      .suggestion-item {
        padding: 10px 16px;
      }

      .add-buttons-panel {
        right: 12px;
        top: 12px;
      }

      .add-button {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      .modal {
        margin: 16px;
        padding: 20px;
      }
    }
    

    .custom-marker-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: all 0.3s ease;
}

.custom-marker-collapsed {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 10px 14px;
  border-radius: 20px;
  font-size: 20px;
  font-weight: 600;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  border: 3px solid white;
  cursor: pointer;
  user-select: none;
}

.custom-marker-label {
  margin-top: 6px;
  background: white;
  padding: 8px 14px;
  font-size: 15px;
  font-weight: 500;
  color: #2d3748;
  border-radius: 12px;
  max-width: 220px;
  text-align: center;
  word-wrap: break-word;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

.custom-marker-wrapper.expanded .custom-marker-label {
  transform: scale(1.05);
}

.custom-marker-delete {
  margin-top: 4px;
  padding: 4px 8px;
  font-size: 14px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.custom-marker-delete:hover {
  background: #dc2626;
}

.hidden {
  display: none;
}

body {
  -webkit-tap-highlight-color: transparent;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  touch-action: manipulation;
  scroll-behavior: smooth;
}

.custom-marker, .symbol-marker, .custom-marker-label, .custom-marker-delete {
  transition: all 0.25s ease-in-out;
  will-change: transform, opacity;
}

button, .search-input {
  transition: all 0.2s ease-in-out;
}

button:active, .add-button:active {
  transform: scale(0.97);
}



    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }


  </style>
</head>
<body>
<div id="map"></div>
<div class="search-container">
  <div class="search-input-container">
    <input 
      type="text" 
      id="search" 
      class="search-input"
      placeholder="–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã, –¥–æ–º–∞ –∏–ª–∏ –º–µ—Å—Ç–∞..." 
      autocomplete="off"
    />
    <button class="clear-search" id="clearSearch" title="–û—á–∏—Å—Ç–∏—Ç—å">√ó</button>
    <div class="search-icon">üîç</div>
  </div>
  <div id="suggestions" class="suggestions"></div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div class="add-buttons-panel">
  <button class="add-button" id="addMarkerBtn" title="–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä">
    üìç
    <div class="add-button-tooltip">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä</div>
  </button>
  <button class="add-button" id="addWarningBtn" title="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ">
    ‚ö†Ô∏è
    <div class="add-button-tooltip">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</div>
  </button>
  <button class="add-button" id="addRoadBlockBtn" title="–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–æ—Ä–æ–≥–∏">
    ‚õî
    <div class="add-button-tooltip">–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ</div>
  </button>
  <button class="add-button" id="addRepairBtn" title="–†–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã">
    üöß
    <div class="add-button-tooltip">–†–µ–º–æ–Ω—Ç</div>
  </button>
  <button class="add-button" id="addEventBtn" title="–°–æ–±—ã—Ç–∏–µ">
    üìÖ
    <div class="add-button-tooltip">–°–æ–±—ã—Ç–∏–µ</div>
  </button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä</div>
    <input type="text" class="modal-input" id="markerText" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
    <div class="modal-buttons">
      <button class="modal-button cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-button confirm" onclick="confirmAddMarker()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { 
    tg.ready(); 
    tg.expand(); 
  }

  // –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –¥–ª—è –í–µ–ª–∏–∫–∏—Ö –õ—É–∫
  const bounds = L.latLngBounds(
    [56.2400, 30.3200],  // –Æ–≥–æ-–ó–∞–ø–∞–¥–Ω–∞—è —Ç–æ—á–∫–∞
    [56.4400, 30.7600]   // –°–µ–≤–µ—Ä–æ-–í–æ—Å—Ç–æ—á–Ω–∞—è —Ç–æ—á–∫–∞
    );
    

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    const map = L.map('map', {
    center: [56.34, 30.54],
    zoom: 15,
    minZoom: 12,
    maxZoom: 19,
    zoomControl: true,
    attributionControl: false,
    maxBounds: bounds,
    maxBoundsViscosity: 0.05
    });


    let userLocationMarker = null;

if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition((position) => {
    const { latitude, longitude } = position.coords;
    const userLatLng = L.latLng(latitude, longitude);

    if (bounds.contains(userLatLng)) {
      userLocationMarker = L.marker(userLatLng, {
        icon: L.divIcon({
          html: `<div style="
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
          "></div>`,
          className: '',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        }),
        interactive: false
      }).addTo(map);

      const btn = document.getElementById('locateMeBtn');
      btn.style.display = 'block';
      btn.addEventListener('click', () => {
        map.flyTo(userLocationMarker.getLatLng(), Math.max(map.getZoom(), 16), { animate: true });
      });

    } else {
      const notice = document.getElementById('geoOutsideNotice');
      if (notice) {
        notice.style.display = 'block';
        setTimeout(() => {
          notice.style.display = 'none';
        }, 5000);
      }
    }

    // –í—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –≥–æ—Ä–æ–¥
    map.setView([56.34, 30.54], 15);

  }, (error) => {
    console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    map.setView([56.34, 30.54], 15);
  }, {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  });
} else {
  map.setView([56.34, 30.54], 15);
}




  




    map.on('moveend', () => {
        const view = map.getBounds();
        const limit = map.options.maxBounds;
        if (!limit.contains(view)) {
            map.panInsideBounds(limit, { animate: true });
        }
    });



  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–π–ª–æ–≤
  const mapTilerKey = 'm4YwiuXxbPBzQaJ1PRc0';
  L.tileLayer(`https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg?key=${mapTilerKey}&lang=ru`, {
    tileSize: 256,
    zoomOffset: 0,
    maxZoom: 19,
    attribution: '¬© MapTiler ¬© OpenStreetMap'
  }).addTo(map);

  const allMarkers = new Set();      // –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã (–≤ —Ç–æ–º —á–∏—Å–ª–µ —É–¥–∞–ª—ë–Ω–Ω—ã–µ)
  const activeMarkers = new Set();   // —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞ –∫–∞—Ä—Ç–µ
  let searchTimeout = null;
  let currentSearchMarker = null;
  let addingMode = null;
  let tempClickPosition = null;

  // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∞—Å–∏–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
function createMarker(lat, lon, label, icon = 'üìç', importance = 2, type = 'default') {
  const container = document.createElement('div');
  container.className = 'custom-marker-wrapper scalable-marker'; // scalable-marker –≤–∞–∂–Ω–æ

  container.innerHTML = `
    <div class="custom-marker-collapsed">${icon}</div>
    <div class="custom-marker-label hidden">${label}</div>
    <button class="custom-marker-delete hidden">‚úñ</button>
  `;

  const marker = L.marker([lat, lon], {
    icon: L.divIcon({
      html: container,
      className: '',
      iconSize: [160, 50],         // –∏–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã
      iconAnchor: [80, 50],        // —Ü–µ–Ω—Ç—Ä –ø–æ X, –Ω–∏–∑ –ø–æ Y

    }),
    importance
  }).addTo(map);

  // –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
  const markerIcon = container.querySelector('.custom-marker-collapsed');
  const labelDiv = container.querySelector('.custom-marker-label');
  const deleteBtn = container.querySelector('.custom-marker-delete');

  markerIcon.addEventListener('click', () => {
    labelDiv.classList.toggle('hidden');
    deleteBtn.classList.toggle('hidden');
    container.classList.toggle('expanded');
  });

  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    map.removeLayer(marker);
    activeMarkers.delete(marker);
    markers.delete(marker);
    markers = markers.filter(m => m !== marker);
  });

  allMarkers.add(marker);
  activeMarkers.add(marker);
  return marker;
}




  // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª—å–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
function createSymbol(lat, lon, label, symbol = '‚õî', color = '#ef4444', importance = 1) {
  const container = document.createElement('div');
  container.className = 'custom-marker-wrapper scalable-marker';

  container.innerHTML = `
    <div class="custom-marker-collapsed" style="background: ${color}; font-size: 22px;">${symbol}</div>
    <div class="custom-marker-label hidden">${label}</div>
    <button class="custom-marker-delete hidden">‚úñ</button>
  `;

  const marker = L.marker([lat, lon], {
    icon: L.divIcon({
      html: container,
      className: '',
      iconSize: [60, 60],
      iconAnchor: [30, 60], // —Ü–µ–Ω—Ç—Ä –ø–æ X, –Ω–∏–∑ –ø–æ Y
    }),
    importance
  }).addTo(map);

  // –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
  const markerIcon = container.querySelector('.custom-marker-collapsed');
  const labelDiv = container.querySelector('.custom-marker-label');
  const deleteBtn = container.querySelector('.custom-marker-delete');

  markerIcon.addEventListener('click', () => {
    labelDiv.classList.toggle('hidden');
    deleteBtn.classList.toggle('hidden');
    container.classList.toggle('expanded');
  });

  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    map.removeLayer(marker);
    activeMarkers.delete(marker);
  });

  allMarkers.add(marker);
  activeMarkers.add(marker);
  return marker;
}



  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –∑—É–º–µ
    map.on('zoomend', () => {
    const zoom = map.getZoom();

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ DOM
    document.querySelectorAll('.scalable-marker').forEach(el => {
        const scale = zoom < 13 ? 0.6 : zoom < 15 ? 0.8 : 1;
        el.style.transform = `scale(${scale})`;
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    activeMarkers.forEach(marker => {
        const importance = marker.options.importance || 2;
        let shouldShow = true;
        if (zoom < 13 && importance > 1) shouldShow = false;
        if (zoom < 12 && importance > 0) shouldShow = false;

        if (shouldShow && !map.hasLayer(marker)) {
        map.addLayer(marker);
        } else if (!shouldShow && map.hasLayer(marker)) {
        map.removeLayer(marker);
        }
    });
    });




  // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞
  const searchInput = document.getElementById('search');
  const suggestionsContainer = document.getElementById('suggestions');
  const clearButton = document.getElementById('clearSearch');

  // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
  const addButtons = {
    marker: document.getElementById('addMarkerBtn'),
    warning: document.getElementById('addWarningBtn'),
    roadBlock: document.getElementById('addRoadBlockBtn'),
    repair: document.getElementById('addRepairBtn'),
    event: document.getElementById('addEventBtn')
  };

  const modal = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const markerTextInput = document.getElementById('markerText');

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  addButtons.marker.addEventListener('click', () => startAddingMode('marker'));
  addButtons.warning.addEventListener('click', () => startAddingMode('warning'));
  addButtons.roadBlock.addEventListener('click', () => startAddingMode('roadBlock'));
  addButtons.repair.addEventListener('click', () => startAddingMode('repair'));
  addButtons.event.addEventListener('click', () => startAddingMode('event'));

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
  map.on('click', function(e) {
    if (addingMode) {
      tempClickPosition = e.latlng;
      showAddMarkerModal();
    }
  });

  function startAddingMode(mode) {
    // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    Object.values(addButtons).forEach(btn => btn.classList.remove('active'));
    
    if (addingMode === mode) {
      // –ï—Å–ª–∏ —Ç–æ—Ç –∂–µ —Ä–µ–∂–∏–º, –æ—Ç–∫–ª—é—á–∏—Ç—å –µ–≥–æ
      addingMode = null;
      map.getContainer().classList.remove('cursor-crosshair');
    } else {
      // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
      addingMode = mode;
      addButtons[mode].classList.add('active');
      map.getContainer().classList.add('cursor-crosshair');
    }
  }

  function showAddMarkerModal() {
    const titles = {
      marker: '–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä',
      warning: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
      roadBlock: '–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–æ—Ä–æ–≥–∏',
      repair: '–†–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã',
      event: '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ'
    };

    modalTitle.textContent = titles[addingMode];
    markerTextInput.value = '';
    
    modal.style.display = 'flex';
    markerTextInput.focus();
  }

  function closeModal() {
    modal.style.display = 'none';
    addingMode = null;
    tempClickPosition = null;
    map.getContainer().classList.remove('cursor-crosshair');
    Object.values(addButtons).forEach(btn => btn.classList.remove('active'));
  }

  function confirmAddMarker() {
    const text = markerTextInput.value.trim();
    
    if (!text || !tempClickPosition) {
      return;
    }

    const lat = tempClickPosition.lat;
    const lon = tempClickPosition.lng;

    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∫–æ–Ω–∫—É –∏ —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Ç–∏–ø—É
    const configs = {
      marker: { icon: 'üìç', color: '#6366f1', isSymbol: false },
      warning: { icon: '‚ö†Ô∏è', color: '#f59e0b', isSymbol: true },
      roadBlock: { icon: '‚õî', color: '#ef4444', isSymbol: true },
      repair: { icon: 'üöß', color: '#f59e0b', isSymbol: true },
      event: { icon: 'üìÖ', color: '#10b981', isSymbol: true }
    };

    const config = configs[addingMode];
    
    if (config.isSymbol) {
      createSymbol(lat, lon, text, config.icon, config.color, 1);
    } else {
      createMarker(lat, lon, text, config.icon, 2);
    }

    closeModal();
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.style.display === 'flex') {
      closeModal();
    }
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –ø–æ–∏—Å–∫
  searchInput.addEventListener('input', handleSearchInput);
  searchInput.addEventListener('focus', () => {
    if (searchInput.value.trim()) {
      suggestionsContainer.style.display = 'block';
    }
  });

  // –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
  clearButton.addEventListener('click', clearSearch);

  // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-container')) {
      suggestionsContainer.style.display = 'none';
    }
  });

  function handleSearchInput() {
    const query = searchInput.value.trim();
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
    clearButton.style.display = query ? 'flex' : 'none';
    
    if (!query) {
      suggestionsContainer.innerHTML = '';
      suggestionsContainer.style.display = 'none';
      return;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    suggestionsContainer.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫...</div>';
    suggestionsContainer.style.display = 'block';

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      performSearch(query);
    }, 300);
  }

  function performSearch(query) {
    // –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Nominatim (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –¥–ª—è —Ä—É—Å—Å–∫–∏—Ö –∞–¥—Ä–µ—Å–æ–≤)
    const searchQueries = [
      `${query}, –í–µ–ª–∏–∫–∏–µ –õ—É–∫–∏, –ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –†–æ—Å—Å–∏—è`,
      `${query}, –í–µ–ª–∏–∫–∏–µ –õ—É–∫–∏`,
      query
    ];

    Promise.all(searchQueries.map(q => 
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5&accept-language=ru&countrycodes=ru&bounded=1&viewbox=30.5,56.28,30.6,56.4`)
        .then(res => res.json())
        .catch(() => [])
    )).then(results => {
      const allResults = results.flat();
      const uniqueResults = [];
      const seen = new Set();

      // –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
      allResults.forEach(place => {
        const key = `${place.lat}_${place.lon}`;
        if (!seen.has(key) && isInBounds(place.lat, place.lon)) {
          seen.add(key);
          uniqueResults.push(place);
        }
      });

      displaySearchResults(uniqueResults.slice(0, 8));
    }).catch(error => {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
      suggestionsContainer.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
    });
  }

  function isInBounds(lat, lon) {
    return lat >= 56.28 && lat <= 56.4 && lon >= 30.5 && lon <= 30.6;
  }

  function displaySearchResults(results) {
    if (results.length === 0) {
      suggestionsContainer.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      return;
    }

    const html = results.map(place => {
      const displayName = formatAddress(place.display_name);
      const type = getPlaceType(place.type, place.class);
      const icon = getPlaceIcon(place.type, place.class);

      return `
        <div class="suggestion-item fade-in" onclick="selectPlace(${place.lat}, ${place.lon}, '${displayName.replace(/'/g, "\\'")}')">
          <span class="suggestion-icon">${icon}</span>
          <div class="suggestion-text">${displayName}</div>
          <span class="suggestion-type">${type}</span>
        </div>
      `;
    }).join('');

    suggestionsContainer.innerHTML = html;
  }

  function formatAddress(displayName) {
    const parts = displayName.split(', ');
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —á–∞—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º–æ–≥–æ –≤–∏–¥–∞
    return relevantParts.join(', ');
  }

  function getPlaceType(type, category) {
    const types = {
      'house': '–î–æ–º',
      'way': '–£–ª–∏—Ü–∞',
      'road': '–î–æ—Ä–æ–≥–∞',
      'residential': '–ñ–∏–ª–æ–π —Ä–∞–π–æ–Ω',
      'commercial': '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π',
      'school': '–®–∫–æ–ª–∞',
      'hospital': '–ë–æ–ª—å–Ω–∏—Ü–∞',
      'shop': '–ú–∞–≥–∞–∑–∏–Ω',
      'restaurant': '–†–µ—Å—Ç–æ—Ä–∞–Ω'
    };
    return types[type] || types[category] || '–ú–µ—Å—Ç–æ';
  }

  function getPlaceIcon(type, category) {
    const icons = {
      'house': 'üè†',
      'way': 'üõ£Ô∏è',
      'road': 'üõ£Ô∏è',
      'residential': 'üèòÔ∏è',
      'school': 'üè´',
      'hospital': 'üè•',
      'shop': 'üè™',
      'restaurant': 'üçΩÔ∏è',
      'commercial': 'üè¢'
    };
    return icons[type] || icons[category] || 'üìç';
  }

  function selectPlace(lat, lon, label) {
    if (currentSearchMarker) {
      map.removeLayer(currentSearchMarker);
    }

    currentSearchMarker = L.marker([lat, lon], {
      icon: L.divIcon({
        html: `<div class="custom-marker" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); font-size: 18px; padding: 12px 20px;">üéØ ${label}</div>`,
        className: '',
        iconSize: [null, null],
        iconAnchor: [null, 45],
        popupAnchor: [0, -45]
      }),
      importance: 3,
      zIndexOffset: 1000
    }).addTo(map);

    currentSearchMarker.bindPopup(`<div>${label}</div>`, {
      offset: [0, 10],
      closeButton: true,
      autoClose: false,
      className: 'beautiful-popup'
    }).openPopup();

    map.setView([lat, lon], Math.max(16, map.getZoom()));
    clearSearch();
  }

  function clearSearch() {
    searchInput.value = '';
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.style.display = 'none';
    clearButton.style.display = 'none';
  }

  window.selectPlace = selectPlace;
  window.closeModal = closeModal;
  window.confirmAddMarker = confirmAddMarker;
</script>
<!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–∏–≥–∞—Ç–æ—Ä" -->
<button id="locateMeBtn" title="–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" style="
  position: absolute;
  bottom: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  font-size: 22px;
  z-index: 1000;
  display: none;
">‚û§</button>

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ "–í—ã –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏" -->
<div id="geoOutsideNotice" style="
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #f87171;
  color: white;
  padding: 12px 20px;
  border-radius: 12px;
  font-weight: 500;
  font-size: 14px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: none;
">
  –í—ã –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –í–µ–ª–∏–∫–∏—Ö –õ—É–∫
</div>

</body>
</html>
