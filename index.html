<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Карта Великих Лук</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #map {
      height: 100%;
      width: 100%;
      border-radius: 0;
    }

    .search-toggle {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1001;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      border-radius: 50%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      font-size: 18px;
      border: none;
    }

    .search-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.35);
    }

    .search-toggle:active {
      transform: translateY(0);
    }

    .search-toggle.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(-2px) scale(0.9);
    }

    .search-box {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      width: 320px;
      max-width: calc(100vw - 40px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .search-box.show {
      display: flex;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
    }

    .search-box.hiding {
      animation: slideOut 0.3s ease;
    }

    .search-input-container {
      position: relative;
      margin-bottom: 8px;
    }

    .search-box input {
      padding: 14px 20px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      background: white;
    }

    .search-box input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .search-box input::placeholder {
      color: #9ca3af;
    }

    .close-search {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
    }

    .close-search:hover {
      background: linear-gradient(135deg, #ff3742 0%, #ff2730 100%);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
    }

    .suggestions {
      max-height: 280px;
      overflow-y: auto;
      font-size: 14px;
      border-radius: 8px;
    }

    .suggestions::-webkit-scrollbar {
      width: 6px;
    }

    .suggestions::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
    }

    .suggestions::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
    }

    .suggestions::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }

    .suggestion-item {
      padding: 14px 16px;
      cursor: pointer;
      border-radius: 10px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
      background: white;
      border: 1px solid #f1f5f9;
      position: relative;
      overflow: hidden;
    }

    .suggestion-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .suggestion-item:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(6px) translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      border-color: transparent;
    }

    .suggestion-item:hover::before {
      left: 100%;
    }

    .suggestion-item:active {
      transform: translateX(4px) translateY(-1px);
    }

    .suggestion-name {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .suggestion-address {
      font-size: 13px;
      opacity: 0.75;
      line-height: 1.3;
    }

    .loading {
      text-align: center;
      padding: 24px;
      color: #667eea;
      font-weight: 500;
      font-size: 15px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #667eea;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-results {
      text-align: center;
      padding: 24px;
      color: #9ca3af;
      font-style: italic;
      font-size: 15px;
    }

    /* Панель инструментов */
    .tools-panel {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tool-button {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 12px;
      background: white;
      color: #2d3748;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tool-button:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: scale(1.05);
    }

    .tool-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* Стили для кастомных маркеров */
    .custom-marker {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 32px;
      height: 32px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 3px solid white;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      animation: markerDrop 0.4s ease-out;
    }

    .house-number {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: bold;
      white-space: nowrap;
    }

    .road-block {
      background: #ff4757 !important;
      border-color: #ff3742 !important;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes markerDrop {
      0% {
        transform: rotate(-45deg) translateY(-50px);
        opacity: 0;
      }
      70% {
        transform: rotate(-45deg) translateY(5px);
        opacity: 1;
      }
      100% {
        transform: rotate(-45deg) translateY(0);
      }
    }

    .marker-icon {
      color: white;
      font-size: 16px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Улучшенные попапы */
    .leaflet-popup-content-wrapper {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .leaflet-popup-content {
      margin: 18px 20px;
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
      text-align: center;
    }

    .leaflet-popup-tip {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }

    /* Улучшенные контролы карты */
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
      border-radius: 16px !important;
      overflow: hidden;
      margin-top: 80px !important;
    }

    .leaflet-control-zoom a {
      border: none !important;
      width: 50px !important;
      height: 50px !important;
      line-height: 50px !important;
      font-size: 20px !important;
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      color: #2d3748 !important;
      transition: all 0.3s ease !important;
      font-weight: bold;
    }

    .leaflet-control-zoom a:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      transform: scale(1.05);
    }

    .leaflet-control-zoom a:first-child {
      border-radius: 16px 16px 0 0 !important;
    }

    .leaflet-control-zoom a:last-child {
      border-radius: 0 0 16px 16px !important;
    }

    /* Улучшения для мобильных устройств */
    @media (max-width: 480px) {
      .search-box {
        width: calc(100vw - 32px);
        left: 16px;
        right: 16px;
      }
      
      .leaflet-control-zoom {
        margin-top: 90px !important;
      }
      
      .leaflet-control-zoom a {
        width: 45px !important;
        height: 45px !important;
        line-height: 45px !important;
        font-size: 18px !important;
      }

      .tools-panel {
        right: 8px;
        top: 8px;
      }

      .tool-button {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Кнопка поиска -->
<button class="search-toggle" id="searchToggle" onclick="toggleSearch()">🔍</button>

<!-- Поле поиска -->
<div class="search-box" id="searchBox">
  <button class="close-search" onclick="toggleSearch()">×</button>
  <div class="search-input-container">
    <input type="text" id="search" placeholder="🔍 Введите название улицы..." oninput="searchAddresses()" />
  </div>
  <div class="suggestions" id="suggestions"></div>
</div>

<!-- Панель инструментов -->
<div class="tools-panel">
  <button class="tool-button" id="roadBlockTool" onclick="toggleTool('roadBlock')" title="Перекрытие дороги">🚫</button>
  <button class="tool-button" id="eventTool" onclick="toggleTool('event')" title="Событие">🎉</button>
  <button class="tool-button" id="warningTool" onclick="toggleTool('warning')" title="Предупреждение">⚠️</button>
  <button class="tool-button" id="infoTool" onclick="toggleTool('info')" title="Информация">ℹ️</button>
</div>

<script>
  // Telegram WebApp API
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#667eea');
  }

  const bounds = L.latLngBounds(
    [56.2800, 30.5000],
    [56.4000, 30.6000]
  );

  const map = L.map('map', {
    center: [56.34, 30.54],
    zoom: 15,
    minZoom: 13,
    maxZoom: 18,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0,
    zoomControl: true
  });

  const mapTilerKey = 'm4YwiuXxbPBzQaJ1PRc0';

  // Красивая карта с русскими надписями
  L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${mapTilerKey}&lang=ru`, {
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18,
    attribution: '© MapTiler © OpenStreetMap'
  }).addTo(map);

  // Контроль границ карты
  map.on('moveend', () => {
    if (!bounds.contains(map.getCenter())) {
      map.panInsideBounds(bounds, { animate: true });
    }
  });

  let searchTimeout;
  let currentMarkers = [];
  let permanentMarkers = [];
  let userMarkers = [];
  let activeTool = null;

  // Система важности мест
  const placeImportance = {
    hospital: 1,
    school: 2,
    bank: 3,
    pharmacy: 4,
    restaurant: 5,
    cafe: 6,
    shop: 7,
    gas_station: 8,
    default: 9
  };

  // Переключение видимости поля поиска
  function toggleSearch() {
    const box = document.getElementById('searchBox');
    const toggle = document.getElementById('searchToggle');
    const searchInput = document.getElementById('search');
    
    if (box.classList.contains('show')) {
      box.classList.add('hiding');
      toggle.classList.remove('hidden');
      
      setTimeout(() => {
        box.classList.remove('show', 'hiding');
        box.style.display = 'none';
        searchInput.value = '';
        document.getElementById('suggestions').innerHTML = '';
      }, 300);
    } else {
      toggle.classList.add('hidden');
      box.style.display = 'flex';
      
      setTimeout(() => {
        box.classList.add('show');
        searchInput.focus();
      }, 10);
    }
  }

  // Переключение инструментов
  function toggleTool(tool) {
    const buttons = document.querySelectorAll('.tool-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (activeTool === tool) {
      activeTool = null;
      map.getContainer().style.cursor = '';
    } else {
      activeTool = tool;
      document.getElementById(tool + 'Tool').classList.add('active');
      map.getContainer().style.cursor = 'crosshair';
    }
  }

  // Обработка клика по карте для добавления пользовательских маркеров
  map.on('click', function(e) {
    if (!activeTool) return;
    
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    const markerData = getToolMarkerData(activeTool);
    const marker = createUserMarker(lat, lng, markerData);
    
    marker.addTo(map);
    userMarkers.push(marker);
    
    // Открываем форму для ввода подписи
    const description = prompt(`Введите описание для ${markerData.title}:`);
    if (description) {
      marker.bindPopup(`<strong>${markerData.title}</strong><br>${description}`);
    } else {
      marker.bindPopup(`<strong>${markerData.title}</strong>`);
    }
  });

  function getToolMarkerData(tool) {
    const tools = {
      roadBlock: { icon: '🛑', title: 'Перекрытие дороги', color: '#ff4757' },
      event: { icon: '🎉', title: 'Событие', color: '#2ed573' },
      warning: { icon: '⚠️', title: 'Предупреждение', color: '#ffa502' },
      info: { icon: 'ℹ️', title: 'Информация', color: '#3742fa' }
    };
    return tools[tool] || tools.info;
  }

  function createUserMarker(lat, lng, markerData) {
    const markerClass = markerData.color === '#ff4757' ? 'custom-marker road-block' : 'custom-marker';
    
    const marker = L.marker([lat, lng], {
      icon: L.divIcon({
        className: markerClass,
        html: `<div class="marker-icon">${markerData.icon}</div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      })
    });
    
    return marker;
  }

  // Создание маркера места
  function createPlaceMarker(lat, lon, place, importance = 9) {
    const name = place.name || place.street || 'Место';
    const houseNumber = place.housenumber || '';
    const type = getPlaceType(place);
    
    const markerHtml = `
      <div class="marker-icon">${getMarkerIcon(type)}</div>
      ${houseNumber ? `<div class="house-number">${houseNumber}</div>` : ''}
    `;
    
    const marker = L.marker([lat, lon], {
      icon: L.divIcon({
        className: 'custom-marker',
        html: markerHtml,
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      }),
      importance: importance
    });
    
    const address = [place.street, place.housenumber, place.city]
      .filter(Boolean)
      .join(', ') || 'Адрес не указан';
    
    marker.bindPopup(`<strong>${name}</strong><br><small>${address}</small>`);
    return marker;
  }

  function getMarkerIcon(type) {
    const icons = {
      location: '📍',
      restaurant: '🍴',
      cafe: '☕',
      shop: '🛍️',
      hospital: '🏥',
      school: '🏫',
      park: '🌳',
      bank: '🏦',
      gas_station: '⛽',
      pharmacy: '💊',
      default: '📍'
    };
    return icons[type] || icons.default;
  }

  // Поиск адресов
  function searchAddresses() {
    const query = document.getElementById('search').value.trim();
    const container = document.getElementById('suggestions');
    
    if (!query) {
      container.innerHTML = '';
      return;
    }

    clearTimeout(searchTimeout);
    container.innerHTML = '<div class="loading">Поиск адресов</div>';
    
    searchTimeout = setTimeout(() => {
      const searchBounds = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
      
      fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query + ' Великие Луки')}&lang=ru&limit=10&bbox=${searchBounds}`)
        .then(res => res.json())
        .then(data => {
          container.innerHTML = '';
          
          if (data.features.length === 0) {
            container.innerHTML = '<div class="no-results">🤷‍♂️ Адреса не найдены<br><small>Попробуйте изменить запрос</small></div>';
            return;
          }

          data.features.forEach(place => {
            const props = place.properties;
            const street = props.street || props.name || 'Неизвестная улица';
            const houseNumber = props.housenumber || '';
            const name = props.name || street;
            
            const displayName = houseNumber ? 
              `${street}, д. ${houseNumber}` : 
              street;
            
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            
            const icon = getMarkerIcon(getPlaceType(props));
            
            item.innerHTML = `
              <div class="suggestion-name">${icon} ${displayName}</div>
              <div class="suggestion-address">${name}</div>
            `;
            
            item.onclick = () => {
              const [lon, lat] = place.geometry.coordinates;
              
              // Удаляем предыдущие маркеры поиска
              currentMarkers.forEach(marker => map.removeLayer(marker));
              currentMarkers = [];
              
              // Создаем новый маркер
              const importance = placeImportance[getPlaceType(props)] || 9;
              const marker = createPlaceMarker(lat, lon, props, importance);
              marker.addTo(map);
              currentMarkers.push(marker);
              
              // Центрируем карту и открываем попап
              map.setView([lat, lon], 17);
              setTimeout(() => {
                marker.openPopup();
              }, 600);
              
              toggleSearch();
            };
            
            container.appendChild(item);
          });
        })
        .catch(error => {
          console.error('Ошибка поиска:', error);
          container.innerHTML = '<div class="no-results">❌ Ошибка поиска<br><small>Проверьте подключение к интернету</small></div>';
        });
    }, 400);
  }

  // Определение типа места
  function getPlaceType(props) {
    const amenity = props.amenity;
    const shop = props.shop;
    
    if (amenity) {
      if (['restaurant', 'fast_food', 'bar', 'pub'].includes(amenity)) return 'restaurant';
      if (['cafe'].includes(amenity)) return 'cafe';
      if (['hospital', 'clinic'].includes(amenity)) return 'hospital';
      if (['pharmacy'].includes(amenity)) return 'pharmacy';
      if (['school', 'university', 'kindergarten'].includes(amenity)) return 'school';
      if (['park', 'garden'].includes(amenity)) return 'park';
      if (['bank', 'atm'].includes(amenity)) return 'bank';
      if (['fuel'].includes(amenity)) return 'gas_station';
    }
    
    if (shop) return 'shop';
    
    return 'location';
  }

  // Управление видимостью маркеров в зависимости от зума
  function updateMarkersVisibility() {
    const zoom = map.getZoom();
    const minZoomForMarkers = 15;
    
    permanentMarkers.forEach(marker => {
      const importance = marker.options.importance || 9;
      const minZoom = minZoomForMarkers + (importance - 1) * 0.3;
      
      if (zoom >= minZoom) {
        if (!map.hasLayer(marker)) {
          map.addLayer(marker);
        }
      } else {
        if (map.hasLayer(marker)) {
          map.removeLayer(marker);
        }
      }
    });
  }

  // Обработчик изменения зума
  map.on('zoomend', updateMarkersVisibility);

  // Загрузка постоянных мест
  function loadPermanentPlaces() {
    const places = [
      { lat: 56.3465, lon: 30.5455, name: 'Кремль Великих Лук', type: 'location', importance: 1 },
      { lat: 56.3421, lon: 30.5234, name: 'Театр драмы им. А.С. Пушкина', type: 'location', importance: 2 },
      { lat: 56.3445, lon: 30.5345, name: 'Центральная площадь', type: 'location', importance: 1 },
      { lat: 56.3456, lon: 30.5389, name: 'Парк Победы', type: 'park', importance: 3 },
      { lat: 56.3478, lon: 30.5456, name: 'Больница №1', type: 'hospital', importance: 1 },
      { lat: 56.3412, lon: 30.5298, name: 'Школа №5', type: 'school', importance: 2 },
      { lat: 56.3489, lon: 30.5367, name: 'Сбербанк', type: 'bank', importance: 3 },
      { lat: 56.3434, lon: 30.5423, name: 'Кафе "Уют"', type: 'cafe', importance: 6 },
      { lat: 56.3467, lon: 30.5298, name: 'Магазин "Пятёрочка"', type: 'shop', importance: 7 }
    ];

    places.forEach(place => {
      const marker = createPlaceMarker(place.lat, place.lon, place, place.importance);
      permanentMarkers.push(marker);
    });

    updateMarkersVisibility();
  }

  // Закрытие поиска при нажатии Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const box = document.getElementById('searchBox');
      if (box.classList.contains('show')) {
        toggleSearch();
      }
      
      // Отключаем активный инстру
